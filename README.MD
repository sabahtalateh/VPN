# Keenetic. Amnezia WireGuard. Host Based Routing

## Покупаем сервер

https://adminvps.ru

Покупаем сервер в каких нибудь Нидерландах или Германии. На почту придут креды

## Устанавливаем Amnezia WireGuard на сервер. Сохраянем конфигурацию для подключения

Скачиваем [Amnezia VPN](https://amnezia.org/en/downloads)

Если ссылка не открывается, можно попробовать следующие варианты

- Попробовать открыть зеркало https://storage.googleapis.com/amnezia/amnezia.org. Работает на момент написание этого документа
- Открыть с помощью какого-нибудь триального/бесплатного ВПН

Инструкция по установке `Amnezia WireGuard` на удалённый сервер. https://docs.amnezia.org/ru/documentation/instructions/install-vpn-on-server. Ниже сокращённый пересказ

- Скачиваем инсталятор для своей ОС
- Запускаем и пишем в него креды от сервера
- Ждём пока инсталятор установит `Amnezia WireGuard` на сервер
- Сохраняем конфигурацию подключения в файл. `Share > Connection Format = Amnezia WG Native Format > Share > Save`

Файл кофигурации будет иметь следующий вид

```
[Interface]
Address = ..
DNS = ..
PrivateKey = ..
Jc = ..
Jmin = ..
Jmax = ..
S1 = ..
S2 = ..
H1 = ..
H2 = ..
H3 = ..
H4 = ..

[Peer]
PublicKey = ..
PresharedKey = ..
AllowedIPs = ..
Endpoint = ..
PersistentKeepalive = ..
```

После этого можно подключиться к `VPN` прямо из скачанного приложение и уже пользоваться. Но мы настроим `VPN` на роутере

## Добавляем VPN-подключение на роутере

- Устанавливаем модуль `WireGuard VPN`. `Настройки > Параметры Системы > Изменить Набор Компонентов`
- Идём в "Другие Подключения". `Сеть > Другие Подключения`
- Загружаем конфигурацию, которую сохранили на предыдущем шаге
- (!) Пока не включаем это подключение
- Заходим в командную строку роутера http://192.168.1.1/a
- Выполняем `show interface`
- Ищем там интерфейс `Wireguard0`
- Выполняем `interface <interface_id> wireguard asc <Jc> <Jmin> <Jmax> <S1> <S2> <H1> <H2> <H3> <H4>`. Переменные в скобках берём из сохранённого конфигурационного файла (это тот файл, который загружали в "Других Подключениях"). `interface_id=Wireguard0`
- Сохраняем изменения. `system configuration save`
- Теперь можно включить соединение

После этого можно добавить соединение в политику по умолчанию, или создать новую политику и перетащить туда нужных клиентов. Но мы этого делать не будем, так как в таком случае весь трафик будет идти через `VPN`. Перейдём к настройке `host-based routing`-а

## opkg + HydraRoute

Установим `opkg` и `HydraRoute` на внешний `USB`, подключённый к роутеру

- Форматируем `USB` в `Ext4` и подключаем его к роутеру
- Устанавливаем `opkg` по [инструкции](https://help.keenetic.com/hc/ru/articles/360021214160-Установка-системы-пакетов-репозитория-Entware-на-USB-накопитель)
  - Тут может не стартовать `ssh`-сервер, тогда [читаем как чинить](https://forum.keenetic.ru/topic/6012-работа-с-entware-при-обновлениях-прошивки-keenetic/). В инструкции старый путь до файла, актуальный путь на момент написания документа такой `/etc/config/dropbear.conf`
- Устанавлиаем `HydraRoute` по [инструкции](https://github.com/Ground-Zerro/HydraRoute). Выбираем Classic
- В политиках подключение добавится 3 новых шутки. В первой уже должно быть наше `VPN`-соединение, если нет, надо его туда добавить
- По адресу http://192.168.1.1:2000 можно настраивать список хостов, которые будут маршрутизироваться `HydraRoute`-ом

В первую политику `HydraRoute` нужно добавить и включить `VPN`-соединение, все устройства можно оставить в политике по умолчанию, трафик будет идти через созданное `VPN`-соединение на основе хоста. В этом можно убедиться, добавив в конфигурацию `HydraRoute` запись `2ip.ru` и посмотреть адрес (`IP` может какое-то время оставаться старым, если так, то надо перезапустить браузер и переподключиться к сети)



